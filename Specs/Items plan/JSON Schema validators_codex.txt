JSON SCHEMA VALIDATORS (CODEX UPDATE)

The schemas below validate the updated agent outputs:
- ChangeSet
- ConceptPacket
- ClarificationPacket
- QuoteDraft
- ResearchFindings

All schemas are Draft 2020-12 and strict (additionalProperties: false).

1) Root schema (agent-output.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/agent-output.schema.json",
  "title": "AgentOutput",
  "type": "object",
  "oneOf": [
    { "$ref": "changeset.schema.json" },
    { "$ref": "concept-packet.schema.json" },
    { "$ref": "clarification-packet.schema.json" },
    { "$ref": "quote-draft.schema.json" },
    { "$ref": "research-findings.schema.json" }
  ]
}
```

2) ChangeSet schema (changeset.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/changeset.schema.json",
  "title": "ChangeSet",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "type",
    "projectId",
    "phase",
    "agentName",
    "summary",
    "assumptions",
    "openQuestions",
    "warnings",
    "items",
    "tasks",
    "accountingLines",
    "uiHints"
  ],
  "properties": {
    "type": { "const": "ChangeSet" },
    "projectId": { "type": "string", "minLength": 1 },
    "phase": {
      "type": "string",
      "enum": ["planning", "solutioning", "accounting", "tasks", "item_edit", "convert"]
    },
    "agentName": { "type": "string", "minLength": 1 },
    "summary": { "type": "string" },
    "assumptions": { "type": "array", "items": { "type": "string" } },
    "openQuestions": { "type": "array", "items": { "type": "string" } },
    "warnings": { "type": "array", "items": { "type": "string" } },

    "items": {
      "type": "object",
      "additionalProperties": false,
      "required": ["create", "patch", "deleteRequest"],
      "properties": {
        "create": { "type": "array", "items": { "$ref": "#/$defs/ItemCreate" } },
        "patch": { "type": "array", "items": { "$ref": "#/$defs/ItemPatch" } },
        "deleteRequest": { "type": "array", "items": { "$ref": "#/$defs/ItemDeleteRequest" } }
      }
    },

    "tasks": {
      "type": "object",
      "additionalProperties": false,
      "required": ["create", "patch", "dependencies"],
      "properties": {
        "create": { "type": "array", "items": { "$ref": "#/$defs/TaskCreate" } },
        "patch": { "type": "array", "items": { "$ref": "#/$defs/TaskPatch" } },
        "dependencies": { "type": "array", "items": { "$ref": "#/$defs/TaskDependency" } }
      }
    },

    "accountingLines": {
      "type": "object",
      "additionalProperties": false,
      "required": ["create", "patch"],
      "properties": {
        "create": { "type": "array", "items": { "$ref": "#/$defs/AccountingLineCreate" } },
        "patch": { "type": "array", "items": { "$ref": "#/$defs/AccountingLinePatch" } }
      }
    },

    "uiHints": {
      "type": "object",
      "additionalProperties": false,
      "required": ["focusItemIds", "expandItemIds", "nextSuggestedAction"],
      "properties": {
        "focusItemIds": { "type": "array", "items": { "type": "string" } },
        "expandItemIds": { "type": "array", "items": { "type": "string" } },
        "nextSuggestedAction": {
          "type": "string",
          "enum": ["approve_changeset", "ask_questions", "run_solutioning", "run_tasks", "generate_quote"]
        }
      }
    }
  },

  "$defs": {
    "Currency": { "type": "string", "enum": ["ILS", "USD", "EUR"] },

    "ItemKind": { "type": "string", "enum": ["deliverable", "service", "day", "fee", "group"] },

    "ItemCategory": {
      "type": "string",
      "enum": [
        "set_piece",
        "print",
        "floor",
        "prop",
        "rental",
        "purchase",
        "transport",
        "installation",
        "studio_production",
        "management",
        "other"
      ]
    },

    "PurchaseMode": { "type": "string", "enum": ["local", "abroad", "both", "none"] },

    "ItemFlags": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "requiresStudio": { "type": "boolean" },
        "requiresPurchase": { "type": "boolean" },
        "purchaseMode": { "$ref": "#/$defs/PurchaseMode" },
        "requiresRental": { "type": "boolean" },
        "requiresMoving": { "type": "boolean" },
        "requiresInstallation": { "type": "boolean" },
        "requiresDismantle": { "type": "boolean" }
      }
    },

    "ItemScope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "quantity": { "type": "number", "minimum": 0 },
        "unit": { "type": "string", "minLength": 1 },
        "dimensions": { "type": "string" },
        "location": { "type": "string" },
        "dueDate": { "type": "string", "format": "date" },
        "constraints": { "type": "array", "items": { "type": "string" } },
        "assumptions": { "type": "array", "items": { "type": "string" } }
      }
    },

    "QuoteDefaults": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "includeByDefault": { "type": "boolean" },
        "displayName": { "type": "string" },
        "taxable": { "type": "boolean" },
        "vatRate": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "ItemCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tempId", "sortKey", "kind", "category", "name", "flags"],
      "properties": {
        "tempId": { "type": "string", "minLength": 1 },
        "parentTempId": { "type": ["string", "null"] },
        "parentItemId": { "type": ["string", "null"] },
        "sortKey": { "type": "string", "minLength": 1 },
        "kind": { "$ref": "#/$defs/ItemKind" },
        "category": { "$ref": "#/$defs/ItemCategory" },
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "flags": { "$ref": "#/$defs/ItemFlags" },
        "scope": { "$ref": "#/$defs/ItemScope" },
        "quoteDefaults": { "$ref": "#/$defs/QuoteDefaults" }
      }
    },

    "ItemPatch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["itemId", "patch"],
      "properties": {
        "itemId": { "type": "string", "minLength": 1 },
        "patch": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string" },
            "description": { "type": "string" },
            "flags": { "$ref": "#/$defs/ItemFlags" },
            "scope": { "$ref": "#/$defs/ItemScope" },
            "quoteDefaults": { "$ref": "#/$defs/QuoteDefaults" }
          }
        }
      }
    },

    "ItemDeleteRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["itemId", "reason", "requiresDoubleConfirm"],
      "properties": {
        "itemId": { "type": "string", "minLength": 1 },
        "reason": { "type": "string" },
        "requiresDoubleConfirm": { "const": true }
      }
    },

    "TaskStatus": { "type": "string", "enum": ["todo", "in_progress", "done", "blocked", "cancelled"] },

    "ItemRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["itemId", "itemTempId"],
      "properties": {
        "itemId": { "type": ["string", "null"] },
        "itemTempId": { "type": ["string", "null"] }
      },
      "anyOf": [
        { "properties": { "itemId": { "type": "string", "minLength": 1 } }, "required": ["itemId"] },
        { "properties": { "itemTempId": { "type": "string", "minLength": 1 } }, "required": ["itemTempId"] }
      ]
    },

    "TaskRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["taskId", "taskTempId"],
      "properties": {
        "taskId": { "type": ["string", "null"] },
        "taskTempId": { "type": ["string", "null"] }
      },
      "anyOf": [
        { "properties": { "taskId": { "type": "string", "minLength": 1 } }, "required": ["taskId"] },
        { "properties": { "taskTempId": { "type": "string", "minLength": 1 } }, "required": ["taskTempId"] }
      ]
    },

    "TaskCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tempId", "itemRef", "title", "durationHours", "status", "tags", "plannedStart", "plannedEnd"],
      "properties": {
        "tempId": { "type": "string", "minLength": 1 },
        "itemRef": { "$ref": "#/$defs/ItemRef" },
        "parentTaskTempId": { "type": ["string", "null"] },
        "title": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "durationHours": { "type": "number", "minimum": 0 },
        "status": { "$ref": "#/$defs/TaskStatus" },
        "tags": { "type": "array", "items": { "type": "string" } },
        "plannedStart": { "type": ["string", "null"], "format": "date-time" },
        "plannedEnd": { "type": ["string", "null"], "format": "date-time" }
      }
    },

    "TaskPatch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["taskId", "patch"],
      "properties": {
        "taskId": { "type": "string", "minLength": 1 },
        "patch": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string" },
            "description": { "type": "string" },
            "durationHours": { "type": "number", "minimum": 0 },
            "status": { "$ref": "#/$defs/TaskStatus" },
            "tags": { "type": "array", "items": { "type": "string" } },
            "plannedStart": { "type": ["string", "null"], "format": "date-time" },
            "plannedEnd": { "type": ["string", "null"], "format": "date-time" }
          }
        }
      }
    },

    "DependencyType": { "type": "string", "enum": ["FS", "SS", "FF", "SF"] },

    "TaskDependency": {
      "type": "object",
      "additionalProperties": false,
      "required": ["fromTaskRef", "toTaskRef", "type", "lagHours"],
      "properties": {
        "fromTaskRef": { "$ref": "#/$defs/TaskRef" },
        "toTaskRef": { "$ref": "#/$defs/TaskRef" },
        "type": { "$ref": "#/$defs/DependencyType" },
        "lagHours": { "type": "number", "minimum": 0 }
      }
    },

    "AccountingLineType": { "type": "string", "enum": ["material", "labor", "purchase", "rental", "shipping", "misc"] },
    "PurchaseStatus": { "type": "string", "enum": ["planned", "quoted", "ordered", "received", "cancelled"] },

    "AccountingLineCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tempId", "itemRef", "taskRef", "lineType", "title", "currency", "taxable", "vatRate", "purchaseStatus"],
      "properties": {
        "tempId": { "type": "string", "minLength": 1 },
        "itemRef": { "$ref": "#/$defs/ItemRef" },
        "taskRef": { "$ref": "#/$defs/TaskRef" },
        "lineType": { "$ref": "#/$defs/AccountingLineType" },
        "title": { "type": "string", "minLength": 1 },
        "notes": { "type": "string" },
        "quantity": { "type": "number", "minimum": 0 },
        "unit": { "type": "string" },
        "unitCost": { "type": "number", "minimum": 0 },
        "currency": { "$ref": "#/$defs/Currency" },
        "taxable": { "type": "boolean" },
        "vatRate": { "type": "number", "minimum": 0, "maximum": 1 },
        "vendorNameFreeText": { "type": "string" },
        "leadTimeDays": { "type": "number", "minimum": 0 },
        "purchaseStatus": { "$ref": "#/$defs/PurchaseStatus" }
      }
    },

    "AccountingLinePatch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["lineId", "patch"],
      "properties": {
        "lineId": { "type": "string", "minLength": 1 },
        "patch": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string" },
            "notes": { "type": "string" },
            "quantity": { "type": "number", "minimum": 0 },
            "unit": { "type": "string" },
            "unitCost": { "type": "number", "minimum": 0 },
            "currency": { "$ref": "#/$defs/Currency" },
            "taxable": { "type": "boolean" },
            "vatRate": { "type": "number", "minimum": 0, "maximum": 1 },
            "vendorNameFreeText": { "type": "string" },
            "leadTimeDays": { "type": "number", "minimum": 0 },
            "purchaseStatus": { "$ref": "#/$defs/PurchaseStatus" }
          }
        }
      }
    }
  }
}
```

3) ConceptPacket schema (concept-packet.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/concept-packet.schema.json",
  "title": "ConceptPacket",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "projectId", "agentName", "summary", "assumptions", "openQuestions", "concepts"],
  "properties": {
    "type": { "const": "ConceptPacket" },
    "projectId": { "type": "string", "minLength": 1 },
    "agentName": { "type": "string", "minLength": 1 },
    "summary": { "type": "string" },
    "assumptions": { "type": "array", "items": { "type": "string" } },
    "openQuestions": { "type": "array", "items": { "type": "string" } },
    "concepts": {
      "type": "object",
      "additionalProperties": false,
      "required": ["create", "patch"],
      "properties": {
        "create": { "type": "array", "items": { "$ref": "#/$defs/ConceptCreate" } },
        "patch": { "type": "array", "items": { "$ref": "#/$defs/ConceptPatch" } }
      }
    }
  },
  "$defs": {
    "FeasibilityLevel": { "type": "string", "enum": ["low", "medium", "high"] },
    "ItemCandidateCategory": {
      "type": "string",
      "enum": ["set_piece", "print", "floor", "prop", "installation", "transport", "management", "other"]
    },
    "ConceptCreate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tempId", "title", "oneLiner", "narrative", "style", "feasibility", "impliedItemCandidates"],
      "properties": {
        "tempId": { "type": "string", "minLength": 1 },
        "title": { "type": "string", "minLength": 1 },
        "oneLiner": { "type": "string", "minLength": 1 },
        "narrative": { "type": "string", "minLength": 1 },
        "style": {
          "type": "object",
          "additionalProperties": false,
          "required": ["materials", "colors", "lighting", "references"],
          "properties": {
            "materials": { "type": "array", "items": { "type": "string" } },
            "colors": { "type": "array", "items": { "type": "string" } },
            "lighting": { "type": "array", "items": { "type": "string" } },
            "references": { "type": "array", "items": { "type": "string" } }
          }
        },
        "feasibility": {
          "type": "object",
          "additionalProperties": false,
          "required": ["studioProduction", "purchases", "rentals", "moving", "installation", "mainRisks"],
          "properties": {
            "studioProduction": { "$ref": "#/$defs/FeasibilityLevel" },
            "purchases": { "$ref": "#/$defs/FeasibilityLevel" },
            "rentals": { "$ref": "#/$defs/FeasibilityLevel" },
            "moving": { "$ref": "#/$defs/FeasibilityLevel" },
            "installation": { "$ref": "#/$defs/FeasibilityLevel" },
            "mainRisks": { "type": "array", "items": { "type": "string" } }
          }
        },
        "impliedItemCandidates": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "category", "notes"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "category": { "$ref": "#/$defs/ItemCandidateCategory" },
              "notes": { "type": "string" }
            }
          }
        }
      }
    },
    "ConceptPatch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["conceptId", "patch"],
      "properties": {
        "conceptId": { "type": "string", "minLength": 1 },
        "patch": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string" },
            "oneLiner": { "type": "string" },
            "narrative": { "type": "string" }
          }
        }
      }
    }
  }
}
```

4) ClarificationPacket schema (clarification-packet.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/clarification-packet.schema.json",
  "title": "ClarificationPacket",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "projectId", "agentName", "summaryOfKnowns", "blockingQuestions", "assumptionsIfNoAnswer", "readyToExtractPlanWhen"],
  "properties": {
    "type": { "const": "ClarificationPacket" },
    "projectId": { "type": "string", "minLength": 1 },
    "agentName": { "type": "string", "minLength": 1 },
    "summaryOfKnowns": {
      "type": "object",
      "additionalProperties": false,
      "required": ["project", "constraints", "selectedItems"],
      "properties": {
        "project": { "type": "array", "items": { "type": "string" } },
        "constraints": { "type": "array", "items": { "type": "string" } },
        "selectedItems": { "type": "array", "items": { "type": "string" } }
      }
    },
    "blockingQuestions": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "scope", "itemId", "question", "whyItMatters"],
        "properties": {
          "id": { "type": "string", "minLength": 1 },
          "scope": { "type": "string", "enum": ["project", "item"] },
          "itemId": { "type": ["string", "null"] },
          "question": { "type": "string", "minLength": 1 },
          "whyItMatters": { "type": "string", "minLength": 1 }
        }
      }
    },
    "assumptionsIfNoAnswer": { "type": "array", "items": { "type": "string" } },
    "readyToExtractPlanWhen": { "type": "array", "items": { "type": "string" } }
  }
}
```

5) QuoteDraft schema (quote-draft.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/quote-draft.schema.json",
  "title": "QuoteDraft",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "projectId", "agentName", "versionNote", "currency", "pricesIncludeVat", "vatRate", "client", "document", "assumptions", "openQuestions"],
  "properties": {
    "type": { "const": "QuoteDraft" },
    "projectId": { "type": "string", "minLength": 1 },
    "agentName": { "type": "string", "minLength": 1 },
    "versionNote": { "type": "string" },
    "currency": { "type": "string", "enum": ["ILS", "USD", "EUR"] },
    "pricesIncludeVat": { "type": "boolean" },
    "vatRate": { "type": "number", "minimum": 0, "maximum": 1 },
    "client": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "company", "email"],
      "properties": {
        "name": { "type": "string" },
        "company": { "type": "string" },
        "email": { "type": "string" }
      }
    },
    "document": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "intro", "scopeBullets", "lineItems", "totals", "paymentTerms", "scheduleAssumptions", "included", "excluded", "termsAndConditions", "validityDays"],
      "properties": {
        "title": { "type": "string", "minLength": 1 },
        "intro": { "type": "string", "minLength": 1 },
        "scopeBullets": { "type": "array", "items": { "type": "string" } },
        "lineItems": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["sortKey", "displayName", "description", "quantity", "unit", "price", "taxable"],
            "properties": {
              "sortKey": { "type": "string", "minLength": 1 },
              "displayName": { "type": "string", "minLength": 1 },
              "description": { "type": "string" },
              "quantity": { "type": "number", "minimum": 0 },
              "unit": { "type": "string", "minLength": 1 },
              "price": { "type": "number", "minimum": 0 },
              "taxable": { "type": "boolean" },
              "vatRate": { "type": "number", "minimum": 0, "maximum": 1 }
            }
          }
        },
        "totals": {
          "type": "object",
          "additionalProperties": false,
          "required": ["subtotal", "vat", "total"],
          "properties": {
            "subtotal": { "type": "number", "minimum": 0 },
            "vat": { "type": "number", "minimum": 0 },
            "total": { "type": "number", "minimum": 0 }
          }
        },
        "paymentTerms": { "type": "array", "items": { "type": "string" } },
        "scheduleAssumptions": { "type": "array", "items": { "type": "string" } },
        "included": { "type": "array", "items": { "type": "string" } },
        "excluded": { "type": "array", "items": { "type": "string" } },
        "termsAndConditions": { "type": "array", "items": { "type": "string" } },
        "validityDays": { "type": "integer", "minimum": 1 }
      }
    },
    "assumptions": { "type": "array", "items": { "type": "string" } },
    "openQuestions": { "type": "array", "items": { "type": "string" } }
  }
}
```

6) ResearchFindings schema (research-findings.schema.json)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio-console.local/schemas/research-findings.schema.json",
  "title": "ResearchFindings",
  "type": "object",
  "additionalProperties": false,
  "required": ["type", "projectId", "agentName", "goal", "queries", "keyFindings", "recommendedNextEdits", "citations", "assumptions", "openQuestions"],
  "properties": {
    "type": { "const": "ResearchFindings" },
    "projectId": { "type": "string", "minLength": 1 },
    "agentName": { "type": "string", "minLength": 1 },
    "goal": { "type": "string", "minLength": 1 },
    "queries": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
    "keyFindings": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["topic", "summary", "options", "estimatedRanges", "leadTimeNotes", "risks"],
        "properties": {
          "topic": { "type": "string", "minLength": 1 },
          "summary": { "type": "string", "minLength": 1 },
          "options": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["name", "pros", "cons", "bestFor"],
              "properties": {
                "name": { "type": "string", "minLength": 1 },
                "pros": { "type": "array", "items": { "type": "string" } },
                "cons": { "type": "array", "items": { "type": "string" } },
                "bestFor": { "type": "array", "items": { "type": "string" } }
              }
            }
          },
          "estimatedRanges": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["what", "low", "high", "currency", "notes"],
              "properties": {
                "what": { "type": "string", "minLength": 1 },
                "low": { "type": "number", "minimum": 0 },
                "high": { "type": "number", "minimum": 0 },
                "currency": { "type": "string", "enum": ["ILS", "USD", "EUR"] },
                "notes": { "type": "string" }
              }
            }
          },
          "leadTimeNotes": { "type": "array", "items": { "type": "string" } },
          "risks": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "recommendedNextEdits": {
      "type": "object",
      "additionalProperties": false,
      "required": ["targetItemIds", "suggestedAccountingLinePatches"],
      "properties": {
        "targetItemIds": { "type": "array", "items": { "type": "string" } },
        "suggestedAccountingLinePatches": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["lineId", "patch"],
            "properties": {
              "lineId": { "type": "string", "minLength": 1 },
              "patch": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "unitCost": { "type": "number", "minimum": 0 },
                  "notes": { "type": "string" },
                  "leadTimeDays": { "type": "number", "minimum": 0 }
                }
              }
            }
          }
        }
      }
    },
    "citations": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["title", "url", "usedFor"],
        "properties": {
          "title": { "type": "string" },
          "url": { "type": "string" },
          "usedFor": { "type": "string" }
        }
      }
    },
    "assumptions": { "type": "array", "items": { "type": "string" } },
    "openQuestions": { "type": "array", "items": { "type": "string" } }
  }
}
```

Implementation tips
- Validate JSON-only before schema validation.
- Route by type: ChangeSet vs QuoteDraft vs ClarificationPacket.
- Tighten requirements after initial stabilization.
